; PlatformIO Project Configuration File
; Project Nightfall - Phase 2 MVP Rescue Robot
; Test Version 2 - Unified WiFi Networking
;
; Build options: build flags, source filter
; Upload options: custom upload port, speed and extra flags
; Library options: dependencies, extra library storages
; Advanced options: extra scripting
;
; Please visit documentation for the other options and examples
; https://docs.platformio.org/page/projectconf.html

[platformio]
default_envs = rear_esp32_v2
src_dir = src
lib_dir = lib
include_dir = include
data_dir = data

; Common monitor settings
[env]
monitor_speed = 115200
framework = arduino
board_build.f_cpu = 240000000L
board_build.flash_mode = dio
board_build.flash_size = 4MB
board_build.core = esp32
board_build.variant = esp32
build_flags = 
    -D VERSION="2.0.0"
    -D BOARD_HAS_PSRAM
lib_deps = 
    bblanchon/ArduinoJson@^7.0.0
    https://github.com/me-no-dev/AsyncTCP.git
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    links2004/WebSockets@^2.4.1
    WiFi

; ===== REAR ESP32 (MASTER/BRAIN) - TEST VERSION 2 =====
[env:rear_esp32_v2]
platform = espressif32
board = esp32dev
board_build.filesystem = littlefs
build_src_filter = +<main_rear.cpp>
build_flags =
    ${env.build_flags}
    -D REAR_ESP32
    -D REAR_CONTROLLER
    -D TEST_VERSION_2_WIFI_NETWORKING
    -D SERIAL_DEBUG
    -D VERBOSE_LOGGING
    -D WIFI_SSID="ProjectNightfall"
    -D WIFI_PASSWORD="rescue2025"
    -D WEBSOCKET_PORT=8888
    -D HTTP_PORT=80
    ; Rear ESP32 Motor Control (L298N #3 - 2 motors)
    ; Using config.h definitions - no need for build flags here
    ; -D MOTOR5_PWM=26
    ; -D MOTOR5_IN1=27
    ; -D MOTOR5_IN2=25
    ; -D MOTOR6_PWM=23
    ; -D MOTOR6_IN3=22
    ; -D MOTOR6_IN4=21
upload_port = /dev/ttyUSB0
monitor_port = /dev/ttyUSB0

; ===== FRONT ESP32 (MOTOR SLAVE) - TEST VERSION 2 =====
[env:front_esp32_v2]
platform = espressif32
board = esp32dev
build_src_filter = +<main_front.cpp>
build_flags =
    ${env.build_flags}
    -D FRONT_ESP32
    -D FRONT_CONTROLLER
    -D TEST_VERSION_2_WIFI_NETWORKING
    -D SERIAL_DEBUG
    -D WIFI_SSID="ProjectNightfall"
    -D WIFI_PASSWORD="rescue2025"
    -D WIFI_HOST="192.168.4.2"
    -D UART_BAUDRATE=115200
    ; Front ESP32 Motor Control (L298N #1 - 2 motors)
    -D MOTOR1_PWM=13
    -D MOTOR1_IN1=23
    -D MOTOR1_IN2=22
    -D MOTOR2_PWM=25
    -D MOTOR2_IN1=26
    -D MOTOR2_IN2=27
    ; Front ESP32 Motor Control (L298N #2 - 2 motors)
    -D MOTOR3_PWM=14
    -D MOTOR3_IN1=32
    -D MOTOR3_IN2=33
    -D MOTOR4_PWM=15
    -D MOTOR4_IN1=19
    -D MOTOR4_IN2=21
lib_deps = 
    bblanchon/ArduinoJson@^7.0.0
    https://github.com/me-no-dev/AsyncTCP.git
    links2004/WebSockets@^2.4.1
    WiFi
upload_port = /dev/ttyUSB1
monitor_port = /dev/ttyUSB1

; ===== CAMERA ESP32 (VISION) - TEST VERSION 2 =====
[env:camera_esp32_v2]
platform = espressif32
board = esp32cam
board_build.filesystem = littlefs
build_src_filter = +<main_camera.cpp>
build_flags =
    ${env.build_flags}
    -D CAMERA_MODULE
    -D CAMERA_ESP32
    -D TEST_VERSION_2_WIFI_NETWORKING
    -D BOARD_HAS_PSRAM
    -D WIFI_SSID="ProjectNightfall"
    -D WIFI_PASSWORD="rescue2025"
    -D WIFI_HOST="192.168.4.3"
    -D CAMERA_PIXEL_FORMAT=PIXFORMAT_JPEG
    -D CAMERA_FRAME_SIZE=FRAMESIZE_VGA
    -D WEBSOCKET_HOST="192.168.4.1"
    -D WEBSOCKET_PORT=8888
    -D CAMERA_STREAM_PORT=81
lib_deps = 
    bblanchon/ArduinoJson@^7.0.0
    https://github.com/me-no-dev/AsyncTCP.git
    links2004/WebSockets@^2.4.1
    WiFi
upload_port = /dev/ttyUSB2
monitor_port = /dev/ttyUSB2

; ===== DEVELOPMENT ENVIRONMENT =====
[env:development]
platform = espressif32
board = esp32dev
build_src_filter = +<main_front.cpp> +<main_rear.cpp> +<main_camera.cpp>
build_flags =
    ${env.build_flags}
    -D DEVELOPMENT_MODE
    -D SERIAL_DEBUG
    -D VERBOSE_LOGGING
    -D WIFI_SSID="DevelopmentNetwork"
    -D WIFI_PASSWORD="DevPassword123"
    -D UART_BAUDRATE=115200
    -D TESTING_ENABLED
upload_port = /dev/ttyUSB0
monitor_port = /dev/ttyUSB0

; ===== TESTING ENVIRONMENT =====
[env:test]
platform = native
build_src_filter = +<test/*> +<lib/*> -<main_*.cpp>
lib_deps = 
    bblanchon/ArduinoJson@^7.0.0
    Unity
build_type = debug
build_flags = 
    ${env.build_flags}
    -D UNIT_TEST
    -D TESTING_ENABLED
    -D UNITY_INCLUDE_CONFIG_H
    -std=c++11

; ===== MOTOR TEST VERSION (LEGACY) =====
[env:back_esp32]
platform = espressif32
board = esp32dev
build_src_filter = +<main_rear_motor_test.cpp>
build_flags =
    ${env.build_flags}
    -D BACK_ESP32
    -D BACK_CONTROLLER
    -D SERIAL_DEBUG
    -D UART_BAUDRATE=115200
    -D UART_RX=16
    -D UART_TX=17
upload_port = /dev/ttyUSB0
monitor_port = /dev/ttyUSB0

[env:front_esp32]
platform = espressif32
board = esp32dev
build_src_filter = +<main_front.cpp>
build_flags =
    ${env.build_flags}
    -D FRONT_ESP32
    -D FRONT_CONTROLLER
    -D SERIAL_DEBUG
    -D UART_BAUDRATE=115200
    -D MOTOR_LEFT_PWM=13
    -D MOTOR_LEFT_IN1=23
    -D MOTOR_LEFT_IN2=22
    -D MOTOR_RIGHT_PWM=25
    -D MOTOR_RIGHT_IN1=26
    -D MOTOR_RIGHT_IN2=27
    -D MOTOR2_LEFT_PWM=14
    -D MOTOR2_LEFT_IN1=32
    -D MOTOR2_LEFT_IN2=33
    -D MOTOR2_RIGHT_PWM=15
    -D MOTOR2_RIGHT_IN1=19
    -D MOTOR2_RIGHT_IN2=21
    -D UART_RX=16
    -D UART_TX=17
upload_port = /dev/ttyUSB1
monitor_port = /dev/ttyUSB1

[env:camera_esp32]
platform = espressif32
board = esp32cam
build_src_filter = +<main_camera.cpp>
build_flags =
    ${env.build_flags}
    -D CAMERA_MODULE
    -D CAMERA_ESP32
    -D BOARD_HAS_PSRAM
    -D UART_BAUDRATE=115200
    -D CAMERA_PIXEL_FORMAT=PIXFORMAT_JPEG
    -D CAMERA_FRAME_SIZE=FRAMESIZE_VGA
    -D FLASH_LED_PIN=4
    -D STATUS_LED_PIN=33
    -D WIFI_SSID="ProjectNightfall"
    -D WIFI_PASSWORD="rescue2025"
    -D WEBSOCKET_HOST="192.168.4.1"
    -D WEBSOCKET_PORT=8888
upload_port = /dev/ttyUSB2
monitor_port = /dev/ttyUSB2

; ===== OPTIMIZED BUILD FOR PRODUCTION =====
[env:production]
platform = espressif32
board = esp32dev
build_src_filter = +<main_front.cpp>
lib_deps =
    bblanchon/ArduinoJson@^6.21.3
    https://github.com/me-no-dev/AsyncTCP.git
    https://github.com/me-no-dev/ESPAsyncWebServer.git
    links2004/WebSockets@^2.4.0
build_flags =
    ${env.build_flags}
    -D PRODUCTION_MODE
    -D SERIAL_DEBUG=0
    -D DEBUG_ENABLED=false
    -D WIFI_SSID="ProjectNightfall"
    -D WIFI_PASSWORD="ProductionPassword2025"
    -D UART_BAUDRATE=115200
    -D OPTIMIZATION_LEVEL=2
    -Os
    -flto
    -DNDEBUG
upload_port = /dev/ttyUSB0
monitor_port = /dev/ttyUSB0

; ===== DEBUG CONFIGURATION =====
[env:debug]
build_type = debug
build_flags = 
    ${env.build_flags}
    -Og
    -g3
    -DDEBUG_MODE
    -DDEBUG_SERIAL

; ===== CHECKING AND VALIDATION =====
[env:check]
platform = espressif32
board = esp32dev
check_tool = cppcheck
check_flags = 
    cppcheck: --enable=all --std=c++11 --platform=unix64
    clangtidy: --checks=*,-readability-magic-numbers
build_src_filter = +<src/*> +<lib/*>

; ===== MONITORING SETTINGS =====
[env:monitor_default]
; Default monitor settings
monitor_rts = 0
monitor_dtr = 0
monitor_raw = false
monitor_echo = true

; ===== OTA UPDATE SUPPORT =====
[env:ota]
platform = espressif32
board = esp32dev
build_src_filter = +<main_front.cpp>
lib_deps =
    ${env:front_esp32.lib_deps}
    ArduinoOTA
build_flags =
    ${env.build_flags}
    -D OTA_ENABLED
    -D OTA_PASSWORD="otapassword123"

; ===== PERFORMANCE BENCHMARKING =====
[env:benchmark]
platform = espressif32
board = esp32dev
build_src_filter = +<main_front.cpp>
lib_deps = ${env:front_esp32.lib_deps}
build_flags = 
    ${env.build_flags}
    -DBENCHMARK_MODE
    -DPERFORMANCE_MONITORING
    -DSTATISTICS_ENABLED

; ===== REMOTE DIAGNOSTICS =====
[env:diagnostics]
platform = espressif32
board = esp32dev
build_src_filter = +<main_front.cpp>
lib_deps = ${env:front_esp32.lib_deps}
build_flags =
    ${env.build_flags}
    -DDIAGNOSTICS_MODE
    -DREMOTE_DEBUG
    -DTELEMETRY_ENABLED
    -DSTATISTICS_COLLECTION
